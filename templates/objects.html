{% extends "base.html" %}
{% import 'macros/hidden_args.jinja2' as macros %}

{% block title %}Objets{% endblock %}

{% block head_extra %}
<style>
  /* Mise en forme locale */
  .accordion-body { position: relative; overflow: hidden; }
  .fab-actions { position: absolute; top: .5rem; right: .5rem; z-index: 2; }
  .object-thumb { max-height: 260px; width: auto; object-fit: contain; }
  .comment-block { max-width: 760px; }
  .tile .card-body { padding: .5rem .5rem; }
  .tile .metric { font-weight: 700; }
  .badge-tag { background: var(--bs-light); color: var(--bs-body-color); border: 1px solid var(--bs-border-color); }
  .tag-add-inline { display: none; min-width: 220px; }
  .tag-controls { gap: .5rem; }
</style>
{% endblock %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="h4 mb-0">Objets</h2>
</div>

<form method="get" class="mb-3">
{{ macros.render_filtered_args(args, ['search', 'sale_filter', 'source_type','page']) }}
  <div class="row g-2 align-items-end">
    <!-- Recherche -->
    <div class="col-12 col-md-5 col-lg-4">
      <label for="search" class="form-label mb-1">Recherche</label>
      <input type="text" class="form-control" id="search" name="search" value="{{ args.get('search','') }}" placeholder="Nom de l'objet...">
    </div>

    <!-- Type de source -->
    <div class="col-6 col-md-3 col-lg-2">
      <label for="source_type" class="form-label mb-1">Type</label>
      <select id="source_type" name="source_type" class="form-select">
        <option value="" {{ '' == args.get('source_type','') and 'selected' or '' }}>Tous</option>
        <option value="print" {{ 'print' == args.get('source_type','') and 'selected' or '' }}>Impressions</option>
        <option value="group" {{ 'group' == args.get('source_type','') and 'selected' or '' }}>Groupes</option>
      </select>
    </div>

    <!-- Filtre Vente -->
    <div class="col-6 col-md-3 col-lg-2">
      <label for="sale_filter" class="form-label mb-1">Vente</label>
      {% set curr_sale = args.get('sale_filter','') %}
      {% if not curr_sale %}
        {# r√©tro-compat: si ancien sold_filter/available encore dans l‚ÄôURL #}
        {% set old_sold = args.get('sold_filter','') %}
        {% set old_av   = args.get('available','') %}
        {% if old_sold == 'yes' %}{% set curr_sale = 'vendus' %}
        {% elif old_av == 'yes' %}{% set curr_sale = 'dispo' %}
        {% endif %}
      {% endif %}
      <select id="sale_filter" name="sale_filter" class="form-select">
        <option value="" {{ '' == curr_sale and 'selected' or '' }}>Tous</option>
        <option value="vendus" {{ 'vendus' == curr_sale and 'selected' or '' }}>Vendus</option>
        <option value="dispo"  {{ 'dispo'  == curr_sale and 'selected' or '' }}>Disponibles</option>
        <option value="offert" {{ 'offert' == curr_sale and 'selected' or '' }}>Offerts</option>
      </select>
    </div>

    <!-- Bouton appliquer -->
    <div class="col-12 col-md-3 col-lg-2 d-grid">
      <label class="form-label mb-1 opacity-0">Appliquer</label>
      <button type="submit" class="btn btn-primary">Filtrer</button>
    </div>
  </div>
</form>

<!-- Tuiles statistiques -->
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6 g-2 mb-3 text-center align-items-stretch">
  <div class="col tile">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div>üì¶</div>
        <div class="metric">{{ total_objects }}</div>
      </div>
    </div>
  </div>
  <div class="col tile">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div>üõí</div>
        <div class="metric">{{ sold_count }}</div>
      </div>
    </div>
  </div>
  <div class="col tile">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div>‚úÖ</div>
        <div class="metric">{{ available_count }}</div>
      </div>
    </div>
  </div>
  <div class="col tile">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div>üéÅ</div>
        <div class="metric">{{ gifted_count }}</div>
      </div>
    </div>
  </div>
  <div class="col tile">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div>üí∂</div>
        <div class="metric">{{ '%.2f'|format(sum_sold_price) }} {{ currencysymbol or '‚Ç¨' }}</div>
      </div>
    </div>
  </div>
  <div class="col tile">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center">
        <div>üìà</div>
        <div class="metric">{{ '%.2f'|format(sum_positive_margin) }} {{ currencysymbol or '‚Ç¨' }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Liste (accord√©on) -->
<div class="accordion" id="objectsAccordion">
  {% if objects|length == 0 %}
    <div class="text-center text-muted py-5">Aucun objet avec ces filtres.</div>
  {% endif %}

  {% for o in objects %}
    {% set item_id = 'obj' ~ o.id %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="heading-{{ item_id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ item_id }}" aria-expanded="false" aria-controls="collapse-{{ item_id }}">
          <div class="d-flex flex-wrap align-items-center w-100 gap-2">
            <span class="fw-semibold me-2">{{ o.name }}</span>
            {% if o.sold_price is not none and o.sold_price > 0 %}
              <span class="badge text-bg-success">Vendu</span>
            {% elif o.sold_price == 0 %}
              <span class="badge text-bg-warning text-dark">Offert</span>
            {% elif o.available %}
              <span class="badge text-bg-info text-dark">Disponible</span>
            {% else %}
              <span class="badge text-bg-secondary">Indisponible</span>
            {% endif %}
            <span class="ms-auto small text-muted">
              Cr√©√© : {{ o.created_at | datetimeformat('fr') }}
              {% if o.updated_at %} ¬∑ Maj : {{ o.updated_at | datetimeformat('fr') }}{% endif %}
            </span>
          </div>
        </button>
      </h2>
      <div id="collapse-{{ item_id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ item_id }}" data-bs-parent="#objectsAccordion">
        <div class="accordion-body">

          <!-- Bouton(s) d‚Äôactions flottant(s) : conteneur pour √©viter tout d√©bordement -->
          <div class="fab-actions">
            {# ‚¨áÔ∏è Recoller ici ton bloc d‚Äôactions existant (menu, ic√¥nes...). #}
            {# Exemple si tu as un include: {% include 'fragments/object_actions.html' %} #}
          </div>

          <!-- Aper√ßu centr√© -->
          <div class="text-center my-2">
            {% if o.thumbnail %}
              <img
                src="{{ o.thumbnail if o.thumbnail.startswith('http') else url_for('static', filename='prints/' ~ o.thumbnail) }}"
                class="img-fluid rounded shadow-sm object-thumb"
                alt="Aper√ßu {{ o.name }}"
              >
            {% else %}
              <div class="text-muted small fst-italic">Aucun aper√ßu disponible</div>
            {% endif %}
          </div>

          <!-- Commentaire fa√ßon print_history -->
          {% if o.comment %}
            <div class="alert alert-secondary comment-block mx-auto mb-3">
              <div class="d-flex align-items-start">
                <div class="me-2">üìù</div>
                <div class="small">{{ o.comment | replace('\n', '<br>') | safe }}</div>
              </div>
            </div>
          {% endif %}

          <!-- Infos en 2 colonnes -->
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
              <ul class="list-unstyled small mb-0">
                <li><span class="text-muted">Nom :</span> {{ o.name }}</li>
                <li><span class="text-muted">Type :</span> {{ o.parent_type or '‚Äî' }}</li>
                <li><span class="text-muted">Disponible :</span> {{ 'Oui' if o.available else 'Non' }}</li>
                <li><span class="text-muted">Cr√©√© :</span> {{ o.created_at | datetimeformat('fr') }}</li>
                <li><span class="text-muted">Maj :</span> {{ (o.updated_at | default(o.created_at) | default('')) | datetimeformat('fr') }}</li>
              </ul>
            </div>
            <div class="col-12 col-md-6">
              <ul class="list-unstyled small mb-0">
                <li>
                  <span class="text-muted">Prix de vente :</span>
                  {% if o.sold_price is not none %}
                    {{ '%.2f'|format(o.sold_price) }} {{ currencysymbol or '‚Ç¨' }}
                  {% else %} ‚Äî {% endif %}
                </li>
                <li>
                  <span class="text-muted">Co√ªt :</span>
                  {% set cost = o.cost_total if o.cost_total is not none else ((o.cost_accessory or 0) + (o.cost_fabrication or 0)) %}
                  {{ '%.2f'|format(cost or 0) }} {{ currencysymbol or '‚Ç¨' }}
                </li>
                <li>
                  <span class="text-muted">Marge :</span>
                  {% if o.margin is not none %}
                    {{ '%.2f'|format(o.margin) }} {{ currencysymbol or '‚Ç¨' }}
                  {% else %}
                    {% if o.sold_price is not none %}
                      {% set m = (o.sold_price or 0) - (cost or 0) %}
                      {{ '%.2f'|format(m) }} {{ currencysymbol or '‚Ç¨' }}
                    {% else %} ‚Äî {% endif %}
                  {% endif %}
                </li>
              </ul>
            </div>
          </div>

          <!-- Tags (style inline comme list_prints / print_card) -->
          <div class="d-flex flex-wrap align-items-center tag-controls">
            {% set tags = obj_tags.get(o.id, []) %}
            {% if tags and tags|length %}
              {% for t in tags %}
                <span class="badge badge-tag">{{ t }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted small">Aucun tag</span>
            {% endif %}

            <!-- Bouton + champ inline pour ajout -->
            <button type="button"
                    class="btn btn-sm btn-outline-primary ms-2"
                    onclick="toggleTagAdd('{{ item_id }}')">+ Tag</button>

            <form class="tag-add-inline ms-1" id="tagAdd-{{ item_id }}" method="post" ><!--action="{{ url_for('add_object_tag') }}"-->
              <input type="hidden" name="object_id" value="{{ o.id }}">
              <div class="input-group input-group-sm">
                <input type="text" name="tag" class="form-control" placeholder="Nouveau tag‚Ä¶" required>
                <button class="btn btn-primary" type="submit">OK</button>
                <button class="btn btn-outline-secondary" type="button" onclick="toggleTagAdd('{{ item_id }}', false)">Annuler</button>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Pagination simple -->
{% if total_pages > 1 %}
<nav class="mt-3">
  <ul class="pagination justify-content-center">
    <li class="page-item {{ 1 == page and 'disabled' or '' }}">
      <a class="page-link"
         href="?page={{ page-1 }}&search={{ args.get('search','') }}&source_type={{ args.get('source_type','') }}&sale_filter={{ args.get('sale_filter','') }}"
         tabindex="-1">Pr√©c√©dent</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Page {{ page }} / {{ total_pages }}</span></li>
    <li class="page-item {{ page == total_pages and 'disabled' or '' }}">
      <a class="page-link"
         href="?page={{ page+1 }}&search={{ args.get('search','') }}&source_type={{ args.get('source_type','') }}&sale_filter={{ args.get('sale_filter','') }}">Suivant</a>
    </li>
  </ul>
</nav>
{% endif %}

{% endblock %}

{% block body_end_extra %}
<script>
  function toggleTagAdd(id, show) {
    const el = document.getElementById('tagAdd-' + id);
    if (!el) return;
    if (show === undefined) {
      el.style.display = (el.style.display === 'inline-block') ? 'none' : 'inline-block';
    } else {
      el.style.display = show ? 'inline-block' : 'none';
    }
    if (el.style.display !== 'none') {
      const input = el.querySelector('input[name="tag"]');
      if (input) { input.focus(); }
    }
  }
</script>
{% endblock %}
