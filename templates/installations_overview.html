{% extends "base.html" %}
{% block content %}
<div class="tile-container">
  <!-- Tuile locale en premier -->
  <div class="tile" id="tile-local">
    <div class="tile-header"><strong>Cette installation</strong></div>
    <img class="snapshot" id="snapshot-local" src="" alt="Snapshot">
    <div class="print-info">
      <div id="print-name-local">...</div>
      <div id="progress-local">...</div>
    </div>
  </div>

  {% for install in installations %}
    <div class="tile" id="tile-{{ install.id }}" data-guest-url="{{ install.guest_url }}">
      <div class="tile-header"><strong>{{ install.label or ('Installation #' ~ install.id) }}</strong></div>
      <img class="snapshot" id="snapshot-{{ install.id }}" src="" alt="Snapshot">
      <div class="print-info">
        <div id="print-name-{{ install.id }}">...</div>
        <div id="progress-{{ install.id }}">...</div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
  function updateTile(tileKey, guestUrl) {
    const q = encodeURIComponent(guestUrl || "");
    fetch(`/api/remote/guest_info?u=${q}`)
      .then(r => r.json())
      .then(d => {
        document.getElementById(`print-name-${tileKey}`).innerText = d.print_name || "(aucun print)";
        document.getElementById(`thumbnail-${tileKey}`).src = d.thumbnail || "";
        document.getElementById(`progress-${tileKey}`).innerText = `Avancement : ${d.progress ?? 0}%`;
      }).catch(() => {
        document.getElementById(`print-name-${tileKey}`).innerText = "(erreur)";
        document.getElementById(`thumbnail-${tileKey}`).src = "";
        document.getElementById(`progress-${tileKey}`).innerText = "";
      });

    document.getElementById(`snapshot-${tileKey}`).src = `/api/remote/snapshot?u=${q}&_=${Date.now()}`;
  }

  // Local en premier
  updateTile("local", "");

  // Distantes
  {% for install in installations %}
    updateTile("{{ install.id }}", "{{ install.guest_url }}");
  {% endfor %}

  setInterval(() => {
    updateTile("local", "");
    {% for install in installations %}
      updateTile("{{ install.id }}", "{{ install.guest_url }}");
    {% endfor %}
  }, 1000);
</script>

<style>
  .tile-container { display:flex; gap:16px; flex-wrap:wrap; }
  .tile { border:1px solid #ccc; border-radius:8px; padding:12px; width:320px; }
  .snapshot { width:100%; border-radius:4px; margin-bottom:8px; }
  .thumbnail { width:100%; max-height:120px; object-fit:contain; margin-top:8px; }
</style>
{% endblock %}

