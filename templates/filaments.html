{% extends 'base.html' %}

{% block content %}
{% import 'macros/hidden_args.jinja2' as macros %}

<style>
/* ====== Styles embarqu√©s sp√©cifiques au catalogue filaments ====== */

/* Accord√©on sombre lisible, sans d√©coupage interne */
.accordion-item.sx {
  border: 0;
  border-radius: 0.75rem;
  overflow: hidden;                 /* √©vite la d√©coupe des √©l√©ments internes */
  background-color: #1e293b;        /* slate-800-ish */
  box-shadow: 0 0 10px rgba(0,0,0,.3);
  margin-bottom: .35rem;
}

/* Bouton d‚Äôen-t√™te */
.accordion-item.sx .accordion-button {
  background-color: #273449;        /* contraste suffisant */
  color: var(--bs-body-color);
  padding: .40rem .5rem;
  font-size: .95rem;
}
.accordion-item.sx .accordion-button:not(.collapsed) {
  box-shadow: inset 0 -1px 0 rgba(255,255,255,.08);
}
.accordion-item.sx .accordion-button:focus {
  box-shadow: none;
}

/* Strip couleur pleine hauteur, jamais coup√©e */
.sx .color-strip {
  flex: 0 0 12px;
  align-self: stretch;              /* prend 100% de la hauteur */
  border-right: 1px solid rgba(255,255,255,.08);
}
.sx .color-strip > div {
  width: 100%;
  height: 100%;
  display: block;
}

/* Badges lisibles en dark */
.badge-sx {
  font-weight: 600;
  letter-spacing: .02em;
  padding: .35rem .5rem;
  border: 1px solid rgba(255,255,255,.08);
  user-select: none;
  border-radius: .5rem;
}
.badge-sx-sec {               /* neutre sombre lisible */
  background: rgba(255,255,255,.08);
  color: #e9ecef;
}
.badge-sx-pri {               /* accent/prix */
  background: var(--bs-primary);
  color: #fff;
}

/* Petites pastilles hex dans le sous-d√©tail */
.hex-pill {
  display: inline-block;
  width: 18px; height: 18px;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,.25);
  vertical-align: -3px;
  margin-right: .25rem;
}

/* R√©duction d‚Äô√©cart sur mobile */
@media (max-width: 576px) {
  .sx .accordion-button { padding: .35rem .4rem; font-size: .92rem; }
  .badge-sx { padding: .28rem .45rem; font-size: .85rem; }
}
</style>

<h2 class="mb-2">Catalogue des filaments</h2>

{# --- Offcanvas filtres (existant si tu l‚Äôas d√©j√†) --- #}
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filtres & Tri</h5>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a class="btn btn-link text-muted" id="resetFiltersBtn" href="{{ url_for(request.endpoint) }}" title="R√©initialiser les filtres">
        <i class="bi bi-arrow-counterclockwise fs-5"></i>
      </a>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2 align-items-end">
      {{ macros.render_filtered_args(args, ['search', 'manufacturer', 'material', 'color', 'sort', 'page']) }}

      <div class="col-md-4">
        <input type="text" name="search" class="form-control" placeholder="Recherche nom, mat√©riau, fabricant, couleur" value="{{ search }}">
      </div>
      <input type="hidden" name="page" value="1">
      <div class="col-md-3">
        {% if all_manufacturers %}
          <select name="manufacturer" class="form-select select2" data-placeholder="Fabricant">
            <option value=""></option>
            {% for manu in all_manufacturers %}
              <option value="{{ manu }}" {% if manu == manufacturer %}selected{% endif %}>{{ manu }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="manufacturer" class="form-control" placeholder="Fabricant" value="{{ manufacturer or '' }}">
        {% endif %}
      </div>
      <div class="col-md-3">
        {% if all_materials %}
          <select name="material" class="form-select select2" data-placeholder="Mat√©riau">
            <option value=""></option>
            {% for mat in all_materials %}
              <option value="{{ mat }}" {% if mat == material %}selected{% endif %}>{{ mat }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="material" class="form-control" placeholder="Mat√©riau" value="{{ material or '' }}">
        {% endif %}
      </div>
      <div class="col-md-2">
        <select name="color" class="form-select select2" data-placeholder="Famille couleur">
          <option value=""></option>
          {% for fam in all_families or [] %}
            <option value="{{ fam }}" {% if fam == selected_family %}selected{% endif %}>{{ fam }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="sort" class="form-select">
          <option value="default" {% if sort == 'default' %}selected{% endif %}>Trier par Mat√©riau/Fabricant/Nom</option>
          <option value="name"    {% if sort == 'name' %}selected{% endif %}>Trier par Nom</option>
          <option value="price"   {% if sort == 'price' %}selected{% endif %}>Trier par Prix</option>
          <option value="weight"  {% if sort == 'weight' %}selected{% endif %}>Trier par Poids filament</option>
        </select>
      </div>

      <div class="col-12 d-flex justify-content-center align-self-end">
        <button type="submit" class="btn btn-primary">Appliquer</button>
      </div>
    </form>
  </div>
</div>

{# --- Stats (optionnel) --- #}
<div class="row row-cols-3 g-2 mb-3 text-center align-items-stretch">
  <div class="col"><div class="card border-0 shadow-sm h-100"><div class="card-body py-2 d-flex flex-column justify-content-center align-items-center">
    <div class="fs-5">üßµ</div><div class="small fw-bold">{{ total_filaments }}</div><div class="text-muted small">Filaments</div>
  </div></div></div>
  <div class="col"><div class="card border-0 shadow-sm h-100"><div class="card-body py-2 d-flex flex-column justify-content-center align-items-center">
    <div class="fs-5">üè∑Ô∏è</div><div class="small fw-bold">{{ total_manufacturers }}</div><div class="text-muted small">Fabricants</div>
  </div></div></div>
  <div class="col"><div class="card border-0 shadow-sm h-100"><div class="card-body py-2 d-flex flex-column justify-content-center align-items-center">
    <div class="fs-5">‚öóÔ∏è</div><div class="small fw-bold">{{ total_materials }}</div><div class="text-muted small">Mat√©riaux</div>
  </div></div></div>
</div>

{# --- Liste accord√©on --- #}
<div class="accordion" id="filamentsCatalogAccordion">
  {% for fil in filaments %}
    <div class="accordion-item sx">
      <h2 class="accordion-header" id="headingFilament{{ fil.id }}">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseFilament{{ fil.id }}"
                aria-expanded="false"
                aria-controls="collapseFilament{{ fil.id }}">
          <div class="d-flex w-100 align-items-stretch gap-2">
            <!-- Strip couleur -->
            <div class="color-strip">
              {% if fil.colors_array %}
                {% set colors = fil.colors_array.split(',') if fil.colors_array is string else fil.colors_array %}
                <div style="background: linear-gradient(180deg,{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %}, {% endif %}{% endfor %});"></div>
              {% elif fil.color %}
                <div style="background:#{{ fil.color|replace('#','') }};"></div>
              {% else %}
                <div style="background:#666;"></div>
              {% endif %}
            </div>

            <!-- Titre -->
            <div class="flex-grow-1 d-flex flex-column justify-content-center ps-1">
              <div class="fw-bold">
                {{ fil.material or '‚Äî' }} ¬∑ {{ fil.manufacturer or '‚Äî' }} ¬∑ {{ fil.name or '‚Äî' }}
              </div>
              <div class="small text-muted">
                {% if fil.multicolor_type and fil.multicolor_type != 'none' %}
                  Multi: {{ fil.multicolor_type }} ¬∑
                {% endif %}
                {% if fil.colors_array %}
                  {% for c in colors %}
                    <span class="hex-pill" style="background:#{{ c|trim|replace('#','') }}"></span>
                  {% endfor %}
                {% elif fil.color %}
                  <span class="hex-pill" style="background:#{{ fil.color|replace('#','') }}"></span>
                {% endif %}
              </div>
            </div>

            <!-- Badges √† droite -->
            <div class="d-flex align-items-center gap-2 pe-2">
              {% if fil.filament_weight_g %}
                <span class="badge badge-sx badge-sx-sec">{{ fil.filament_weight_g }} g</span>
              {% endif %}
              {% if fil.spool_weight_g %}
                <span class="badge badge-sx badge-sx-sec">{{ fil.spool_weight_g }} g tare</span>
              {% endif %}
              <span class="badge badge-sx badge-sx-pri">
                {{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}
              </span>
            </div>
          </div>
        </button>
      </h2>

      <div id="collapseFilament{{ fil.id }}" class="accordion-collapse collapse" aria-labelledby="headingFilament{{ fil.id }}" data-bs-parent="#filamentsCatalogAccordion">
        <div class="accordion-body">
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Nom :</strong> {{ fil.name or '‚Äî' }}</li>
                <li><strong>Fabricant :</strong> {{ fil.manufacturer or '‚Äî' }}</li>
                <li><strong>Mat√©riau :</strong> {{ fil.material or '‚Äî' }}</li>
                <li><strong>Couleur(s) :</strong>
                  {% if fil.colors_array %}
                    <span class="hex-pill" style="width:22px;height:22px;vertical-align:-5px;background: linear-gradient(90deg,{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %}, {% endif %}{% endfor %});"></span>
                    <span class="ms-2">{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %} / {% endif %}{% endfor %}</span>
                  {% elif fil.color %}
                    <span class="hex-pill" style="width:22px;height:22px;vertical-align:-5px;background:#{{ fil.color|replace('#','') }}"></span>
                    <span class="ms-2">#{{ fil.color|replace('#','') }}</span>
                  {% else %} ‚Äî {% endif %}
                </li>
                <li><strong>Profil ID :</strong> {{ fil.profile_id or '‚Äî' }}</li>
                <li><strong>R√©f√©rence :</strong> {{ fil.reference_id or '‚Äî' }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Prix :</strong> {{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}</li>
                <li><strong>Poids filament :</strong> {{ fil.filament_weight_g or '‚Äî' }} g</li>
                <li><strong>Tare bobine :</strong> {{ fil.spool_weight_g or '‚Äî' }} g</li>
                <li><strong>Cr√©√© le :</strong> {% if fil.created_at %}{{ fil.created_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>Mis √† jour :</strong> {% if fil.updated_at %}{{ fil.updated_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>External ID :</strong> {{ fil.external_filament_id or '‚Äî' }}</li>
              </ul>
            </div>
            {% if fil.comment %}
            <div class="col-12">
              <div class="small text-muted"><strong>Commentaire :</strong><br>{{ fil.comment }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-secondary">Aucun filament trouv√©.</div>
  {% endfor %}
</div>
<div style="height: 4rem;"></div>
{% endblock %}
