{% extends 'base.html' %}

{% block content %}
{% import 'macros/hidden_args.jinja2' as macros %}

{# =====================================================================
   STYLES LOCAUX (embarqu√©) ‚Äî m√™mes patterns que bobines + corrections UI
   ===================================================================== #}
<style>
/* Accord√©on sombre identique √† bobines */
.accordion-item.sx {
  border: 0;
  border-radius: 0.75rem;
  overflow: hidden;
  background-color: #1e293b; /* identique bobines */
  box-shadow: 0 0 10px rgba(0,0,0,.3);
  margin-bottom: .35rem;
}
.accordion-item.sx .accordion-button {
  background-color: #1e293b; /* idem bobines */
  color: #e9ecef;
  padding: .40rem .5rem;
  font-size: .95rem;
}
.accordion-item.sx .accordion-button:not(.collapsed) {
  box-shadow: inset 0 -1px 0 rgba(255,255,255,.08);
}
.accordion-item.sx .accordion-button:focus { box-shadow: none; }

/* Badges sobres identiques bobines */
.badge-sx {
  font-weight: 600;
  padding: .35rem .5rem;
  background: rgba(255,255,255,.08);
  color: #e9ecef;
  border-radius: .5rem;
}
/* Strip couleur pleine hauteur */
.sx .color-strip {
  flex: 0 0 12px;
  align-self: stretch;
  border-right: 1px solid rgba(255,255,255,.08);
}
.sx .color-strip > div { width: 100%; height: 100%; display: block; }

/* Petites pastilles hex dans le sous-d√©tail */
.hex-pill {
  display: inline-block;
  width: 18px; height: 18px;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,.25);
  vertical-align: -3px;
  margin-right: .25rem;
}

@media (max-width: 576px) {
  .sx .accordion-button { padding: .35rem .4rem; font-size: .92rem; }
  .badge-sx { padding: .28rem .45rem; font-size: .85rem; }
}
</style>

{# =========================== en-t√™te titre =========================== #}

{# ===== Bouton flottant pagination (identique √† bobines) ===== #}
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas"
          aria-controls="paginationOffcanvas">
    üìÑ
  </button>
</div>

{# ===== Bouton flottant filtres (identique √† bobines) ===== #}
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas"
          aria-controls="filtersOffcanvas">
    üîç
  </button>
</div>

{# ========================== OFFCANVAS FILTRES ======================== #}
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filtres & Tri</h5>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a class="btn btn-link text-muted" id="resetFiltersBtn"
         href="{{ url_for(request.endpoint) }}" title="R√©initialiser les filtres">
        <i class="bi bi-arrow-counterclockwise fs-5"></i>
      </a>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2 align-items-end">
      {# on conserve les param√®tres comme dans bobines #}
      {{ macros.render_filtered_args(args, ['search','color','sort','page','manufacturer','material']) }}

      <div class="col-md-4">
        <input type="text" name="search" class="form-control"
               placeholder="Recherche nom, mat√©riau, fabricant ou couleur"
               value="{{ search }}">
      </div>

      <input type="hidden" name="page" value="1">

      <div class="col-md-3">
        <select name="color" class="form-select select2" data-placeholder="Famille couleur">
          <option value=""></option>
          {% for fam in all_families or [] %}
            <option value="{{ fam }}" {% if fam == selected_family %}selected{% endif %}>{{ fam }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        {% if all_materials %}
          <select name="material" class="form-select select2" data-placeholder="Mat√©riau">
            <option value=""></option>
            {% for mat in all_materials %}
              <option value="{{ mat }}" {% if mat == material %}selected{% endif %}>{{ mat }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="material" class="form-control" placeholder="Mat√©riau" value="{{ material or '' }}">
        {% endif %}
      </div>

      <div class="col-md-3">
        {% if all_manufacturers %}
          <select name="manufacturer" class="form-select select2" data-placeholder="Fabricant">
            <option value=""></option>
            {% for manu in all_manufacturers %}
              <option value="{{ manu }}" {% if manu == manufacturer %}selected{% endif %}>{{ manu }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="manufacturer" class="form-control" placeholder="Fabricant" value="{{ manufacturer or '' }}">
        {% endif %}
      </div>

      <div class="col-md-3">
        <select name="sort" class="form-select">
          <option value="default" {% if sort == 'default' %}selected{% endif %}>Trier par Mat√©riau/Fabricant/Nom</option>
          <option value="name"    {% if sort == 'name'    %}selected{% endif %}>Trier par Nom</option>
          <option value="price"   {% if sort == 'price'   %}selected{% endif %}>Trier par Prix</option>
          <option value="weight"  {% if sort == 'weight'  %}selected{% endif %}>Trier par Poids filament</option>
        </select>
      </div>

      <div class="col-12 d-flex justify-content-center align-self-end">
        <button type="submit" class="btn btn-primary">Appliquer</button>
      </div>
    </form>
  </div>
</div>

{# ======================= OFFCANVAS PAGINATION ======================= #}
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas" aria-labelledby="paginationOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="paginationOffcanvasLabel">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <label for="pageInput" class="me-1">Page</label>
        <input type="number" min="1" max="{{ total_pages }}" id="pageInput" name="page"
               class="form-control form-control-sm" style="width: 64px;" value="{{ page }}">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>

{# ============================ STATISTIQUES =========================== #}
<div class="row row-cols-3 g-2 mb-3 text-center align-items-stretch">
  <div class="col">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üßµ</div>
        <div class="small fw-bold">{{ total_filaments }}</div>
        <div class="text-muted small">Filaments</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üè≠</div>
        <div class="small fw-bold">{{ total_manufacturers }}</div>
        <div class="text-muted small">Fabricants</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">‚öóÔ∏è</div>
        <div class="small fw-bold">{{ total_materials }}</div>
        <div class="text-muted small">Mat√©riaux</div>
      </div>
    </div>
  </div>
</div>

{# ============================= LISTE ================================ #}
<div class="accordion" id="filamentsCatalogAccordion">
  {% for fil in filaments %}
    <div class="accordion-item sx">
      <h2 class="accordion-header" id="headingFilament{{ fil.id }}">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseFilament{{ fil.id }}"
                aria-expanded="false"
                aria-controls="collapseFilament{{ fil.id }}">
          <div class="d-flex w-100 align-items-stretch gap-2">
            <!-- Strip couleur -->
            <div class="color-strip">
              {% if fil.colors_array %}
                {% set colors = fil.colors_array.split(',') if fil.colors_array is string else fil.colors_array %}
                <div style="background: linear-gradient(180deg,{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %}, {% endif %}{% endfor %});"></div>
              {% elif fil.color %}
                <div style="background:#{{ fil.color|replace('#','') }};"></div>
              {% else %}
                <div style="background:#666;"></div>
              {% endif %}
            </div>

            <!-- Titre -->
            <div class="flex-grow-1 d-flex flex-column justify-content-center ps-1">
              <div class="fw-bold">
                {{ fil.material or '‚Äî' }} ¬∑ {{ fil.manufacturer or '‚Äî' }} ¬∑ {{ fil.name or '‚Äî' }}
              </div>
              <div class="small text-muted">
                {% if fil.multicolor_type and fil.multicolor_type != 'none' %}
                  Multi: {{ fil.multicolor_type }} ¬∑
                {% endif %}
                {% if fil.colors_array %}
                  {% for c in colors %}
                    <span class="hex-pill" style="background:#{{ c|trim|replace('#','') }}"></span>
                  {% endfor %}
                {% elif fil.color %}
                  <span class="hex-pill" style="background:#{{ fil.color|replace('#','') }}"></span>
                {% endif %}
              </div>
            </div>

            <!-- Badges √† droite -->
            <div class="d-flex align-items-center gap-2 pe-2">
              {% if fil.filament_weight_g %}
                <span class="badge badge-sx badge-sx-sec">{{ fil.filament_weight_g }} g</span>
              {% endif %}
              {% if fil.spool_weight_g %}
                <span class="badge badge-sx badge-sx-sec">{{ fil.spool_weight_g }} g tare</span>
              {% endif %}
              <span class="badge badge-sx badge-sx-pri">
                {{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}
              </span>
            </div>
          </div>
        </button>
      </h2>

      <div id="collapseFilament{{ fil.id }}" class="accordion-collapse collapse" aria-labelledby="headingFilament{{ fil.id }}" data-bs-parent="#filamentsCatalogAccordion">
        <div class="accordion-body">
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Nom :</strong> {{ fil.name or '‚Äî' }}</li>
                <li><strong>Fabricant :</strong> {{ fil.manufacturer or '‚Äî' }}</li>
                <li><strong>Mat√©riau :</strong> {{ fil.material or '‚Äî' }}</li>
                <li><strong>Couleur(s) :</strong>
                  {% if fil.colors_array %}
                    <span class="hex-pill" style="width:22px;height:22px;vertical-align:-5px;background: linear-gradient(90deg,{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %}, {% endif %}{% endfor %});"></span>
                    <span class="ms-2">{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %} / {% endif %}{% endfor %}</span>
                  {% elif fil.color %}
                    <span class="hex-pill" style="width:22px;height:22px;vertical-align:-5px;background:#{{ fil.color|replace('#','') }}"></span>
                    <span class="ms-2">#{{ fil.color|replace('#','') }}</span>
                  {% else %} ‚Äî {% endif %}
                </li>
                <li><strong>Profil ID :</strong> {{ fil.profile_id or '‚Äî' }}</li>
                <li><strong>R√©f√©rence :</strong> {{ fil.reference_id or '‚Äî' }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Prix :</strong> {{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}</li>
                <li><strong>Poids filament :</strong> {{ fil.filament_weight_g or '‚Äî' }} g</li>
                <li><strong>Tare bobine :</strong> {{ fil.spool_weight_g or '‚Äî' }} g</li>
                <li><strong>Cr√©√© le :</strong> {% if fil.created_at %}{{ fil.created_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>Mis √† jour :</strong> {% if fil.updated_at %}{{ fil.updated_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>External ID :</strong> {{ fil.external_filament_id or '‚Äî' }}</li>
              </ul>
            </div>
            {% if fil.comment %}
            <div class="col-12">
              <div class="small text-muted"><strong>Commentaire :</strong><br>{{ fil.comment }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-secondary">Aucun filament trouv√©.</div>
  {% endfor %}
</div>

{# ====================== SCRIPTS PAGE (optionnels) ==================== #}
{% block scripts %}
{{ super() }}
<script>
  // Reset des filtres (comme bobines)
  document.getElementById('resetFiltersBtn')?.addEventListener('click', function(e){
    // rien √† faire: on redirige d√©j√† vers l'endpoint sans args
  });
</script>
{% endblock %}

<div style="height: 4rem;"></div>
{% endblock %}
