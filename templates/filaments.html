{% extends 'base.html' %}

{% block content %}
{% import 'macros/hidden_args.jinja2' as macros %}

{#
  Catalogue des FILAMENTS (table locale `filaments`), organis√© comme `bobines.html` :
  - Offcanvas Filtres & Tri (recherche, fabricant, mat√©riau, famille couleur)
  - Offcanvas Pagination (identique)
  - Cartes de stats
  - Liste en accord√©on (couleurs, infos techniques, prix, poids, ids, commentaires)

  Variables attendues (align√©es avec app.py / filaments.py) :
    filaments            : liste pagin√©e de lignes (sqlite3.Row)
    page, total_pages    : pagination
    search               : texte de recherche
    manufacturer         : fabricant s√©lectionn√© (optionnel)
    material             : mat√©riau s√©lectionn√© (optionnel)
    all_manufacturers    : liste (distinct) des fabricants disponibles (apr√®s filtres de recherche)
    all_materials        : liste (distinct) des mat√©riaux disponibles (apr√®s filtres de recherche)
    all_families         : liste des familles de couleurs calcul√©es
    selected_family      : famille de couleur s√©lectionn√©e
    sort                 : "default" | "price" | "weight" | "name"
    total_filaments      : nombre total (apr√®s filtres)
    total_manufacturers  : nb fabricants distincts (apr√®s filtres)
    total_materials      : nb mat√©riaux distincts (apr√®s filtres)
    avg_price            : moyenne des prix (apr√®s filtres) (optionnel)
    avg_weight           : poids filament moyen en g (apr√®s filtres) (optionnel)
    args                 : _merge_context_args() depuis app.context_processor
#}

<!-- Bouton flottant pagination -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button" data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas" aria-controls="paginationOffcanvas">
    üìÑ
  </button>
</div>

<!-- Bouton flottant filtres -->
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">
    üîç
  </button>
</div>

<!-- Offcanvas Filtres & Tri -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filtres & Tri</h5>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a class="btn btn-link text-muted" id="resetFiltersBtn" href="{{ url_for(request.endpoint) }}" title="R√©initialiser les filtres">
        <i class="bi bi-arrow-counterclockwise fs-5"></i>
      </a>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2 align-items-end">
      {{ macros.render_filtered_args(args, ['search', 'manufacturer', 'material', 'color', 'sort', 'page']) }}

      <div class="col-md-4">
        <input type="text" name="search" class="form-control" placeholder="Recherche nom, mat√©riau, fabricant, couleur" value="{{ search }}">
      </div>

      <input type="hidden" name="page" value="1">

      <div class="col-md-3">
        {% if all_manufacturers is defined and all_manufacturers %}
          <select name="manufacturer" class="form-select select2" data-placeholder="Fabricant">
            <option value=""></option>
            {% for manu in all_manufacturers %}
              <option value="{{ manu }}" {% if manu == manufacturer %}selected{% endif %}>{{ manu }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="manufacturer" class="form-control" placeholder="Fabricant" value="{{ manufacturer or '' }}">
        {% endif %}
      </div>

      <div class="col-md-3">
        {% if all_materials is defined and all_materials %}
          <select name="material" class="form-select select2" data-placeholder="Mat√©riau">
            <option value=""></option>
            {% for mat in all_materials %}
              <option value="{{ mat }}" {% if mat == material %}selected{% endif %}>{{ mat }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="material" class="form-control" placeholder="Mat√©riau" value="{{ material or '' }}">
        {% endif %}
      </div>

      <div class="col-md-2">
        <select name="color" class="form-select select2" data-placeholder="Famille couleur">
          <option value=""></option>
          {% for fam in all_families or [] %}
            <option value="{{ fam }}" {% if fam == selected_family %}selected{% endif %}>{{ fam }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select name="sort" class="form-select">
          <option value="default" {% if sort == 'default' %}selected{% endif %}>Trier par Mat√©riau/Fabricant/Nom</option>
          <option value="name" {% if sort == 'name' %}selected{% endif %}>Trier par Nom</option>
          <option value="price" {% if sort == 'price' %}selected{% endif %}>Trier par Prix</option>
          <option value="weight" {% if sort == 'weight' %}selected{% endif %}>Trier par Poids filament</option>
        </select>
      </div>

      <div class="col-12 d-flex justify-content-center align-self-end">
        <button type="submit" class="btn btn-primary">Appliquer</button>
      </div>
    </form>
  </div>
</div>

<!-- Offcanvas Pagination -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas" aria-labelledby="paginationOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="paginationOffcanvasLabel">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <label for="pageInput" class="me-1">Page</label>
        <input type="number" min="1" max="{{ total_pages }}" id="pageInput" name="page" class="form-control form-control-sm" style="width: 64px;" value="{{ page }}">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Statistiques -->
<div class="row row-cols-3 g-2 mb-3 text-center align-items-stretch">
  <div class="col">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üßµ</div>
        <div class="small fw-bold">{{ total_filaments }}</div>
        <div class="text-muted small">Filaments</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üè∑Ô∏è</div>
        <div class="small fw-bold">{{ total_manufacturers }}</div>
        <div class="text-muted small">Fabricants</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">‚öóÔ∏è</div>
        <div class="small fw-bold">{{ total_materials }}</div>
        <div class="text-muted small">Mat√©riaux</div>
      </div>
    </div>
  </div>
</div>

<!-- Liste en accord√©on -->
<div class="accordion" id="filamentsCatalogAccordion">
  {% for fil in filaments %}
    <div class="accordion-item" style="border-radius: 0.75rem; margin-bottom: .3rem; background-color: #1e293b; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
      <h2 class="accordion-header d-flex justify-content-between align-items-center" id="headingFilament{{ fil.id }}" style="border-radius: 0.75rem;">
        <div class="flex-grow-1">
          <button class="accordion-button collapsed py-1 px-3 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilament{{ fil.id }}" aria-expanded="false" aria-controls="collapseFilament{{ fil.id }}" style="border-radius: 0.75rem; font-size: 0.9rem;">
            <div class="d-flex w-100 align-items-stretch gap-2">
              <!-- Barre couleur √† gauche -->
              <div class="d-flex align-items-stretch" style="width: 12px;">
                {% if fil.colors_array %}
                  {% set colors = fil.colors_array.split(',') if fil.colors_array is string else fil.colors_array %}
                  <div style="width: 12px; border-radius: 0.5rem 0 0 0.5rem; background: linear-gradient(180deg, {% for c in colors %}#{{ c.strip().lstrip('#') }}{% if not loop.last %}, {% endif %}{% endfor %});"></div>
                {% elif fil.color %}
                  <div style="width: 12px; border-radius: 0.5rem 0 0 0.5rem; background: #{{ fil.color.lstrip('#') }};"></div>
                {% else %}
                  <div style="width: 12px; border-radius: 0.5rem 0 0 0.5rem; background: #999;"></div>
                {% endif %}
              </div>

              <!-- Titre principal -->
              <div class="flex-grow-1 d-flex flex-column justify-content-center">
                <div class="fw-bold">
                  {{ fil.material or '‚Äî' }} ¬∑ {{ fil.manufacturer or '‚Äî' }} ¬∑ {{ fil.name or '‚Äî' }}
                </div>
                <div class="small text-muted">
                  {% if fil.multicolor_type and fil.multicolor_type != 'none' %}
                    Multi: {{ fil.multicolor_type }} ¬∑
                  {% endif %}
                  {% if fil.colors_array %}
                    {% set colors = fil.colors_array.split(',') if fil.colors_array is string else fil.colors_array %}
                    {% for c in colors %}<span class="badge rounded-pill bg-secondary me-1">#{{ c.strip().lstrip('#') }}</span>{% endfor %}
                  {% elif fil.color %}
                    <span class="badge rounded-pill bg-secondary">#{{ fil.color.lstrip('#') }}</span>
                  {% endif %}
                </div>
              </div>

              <!-- Prix & Poids synth√®se -->
              <div class="d-flex align-items-center gap-3 pe-2">
                <span class="badge bg-dark-subtle text-dark">{{ fil.filament_weight_g or '‚Äî' }} g</span>
                <span class="badge bg-dark-subtle text-dark">{{ fil.spool_weight_g or '‚Äî' }} g tare</span>
                <span class="badge bg-primary">{{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}</span>
              </div>
            </div>
          </button>
        </div>
      </h2>

      <div id="collapseFilament{{ fil.id }}" class="accordion-collapse collapse" aria-labelledby="headingFilament{{ fil.id }}" data-bs-parent="#filamentsCatalogAccordion">
        <div class="accordion-body">
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Nom :</strong> {{ fil.name or '‚Äî' }}</li>
                <li><strong>Fabricant :</strong> {{ fil.manufacturer or '‚Äî' }}</li>
                <li><strong>Mat√©riau :</strong> {{ fil.material or '‚Äî' }}</li>
                <li><strong>Couleur(s) :</strong>
                  {% if fil.colors_array %}
                    {% set colors = fil.colors_array.split(',') if fil.colors_array is string else fil.colors_array %}
                    <span style="display:inline-block;width:20px;height:20px;vertical-align:middle; background: linear-gradient(90deg, {% for c in colors %}#{{ c.strip().lstrip('#') }}{% if not loop.last %}, {% endif %}{% endfor %}); border-radius:4px; border:1px solid #ccc;"></span>
                    <span class="ms-2">{% for c in colors %}#{{ c.strip().lstrip('#') }}{% if not loop.last %} / {% endif %}{% endfor %}</span>
                  {% elif fil.color %}
                    <span style="display:inline-block;width:20px;height:20px;vertical-align:middle; background:#{{ fil.color.lstrip('#') }}; border-radius:4px; border:1px solid #ccc;"></span>
                    <span class="ms-2">#{{ fil.color.lstrip('#') }}</span>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </li>
                <li><strong>Profil ID :</strong> {{ fil.profile_id or '‚Äî' }}</li>
                <li><strong>R√©f√©rence :</strong> {{ fil.reference_id or '‚Äî' }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Prix :</strong> {{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}</li>
                <li><strong>Poids filament :</strong> {{ fil.filament_weight_g or '‚Äî' }} g</li>
                <li><strong>Tare bobine :</strong> {{ fil.spool_weight_g or '‚Äî' }} g</li>
                <li><strong>Cr√©√© le :</strong> {% if fil.created_at %}{{ fil.created_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>Mis √† jour :</strong> {% if fil.updated_at %}{{ fil.updated_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>External ID :</strong> {{ fil.external_filament_id or '‚Äî' }}</li>
              </ul>
            </div>
            {% if fil.comment %}
            <div class="col-12">
              <div class="small text-muted"><strong>Commentaire :</strong><br>{{ fil.comment }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-secondary">Aucun filament trouv√©.</div>
  {% endfor %}
</div>

{% endblock %}
