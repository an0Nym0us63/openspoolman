<div class="modal fade" id="spoolModal" tabindex="-1" aria-labelledby="spoolModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="spoolModalLabel">Créer une bobine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="spoolForm">
          <input type="hidden" id="spool_id">

          <div class="mb-3">
            <label class="form-label">Filament</label>
            <select id="spool_filament_id" class="form-select" placeholder="Choisir un filament…"></select>
            <div class="form-text">Tape pour rechercher (fabricant, matériau, nom).</div>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Prix (€)</label>
              <input type="number" min="0" step="0.01" inputmode="decimal" class="form-control" id="spool_price" placeholder="ex: 24.90">
            </div>
            <div class="col-md-4">
              <label class="form-label">Poids restant (g)</label>
              <input type="number" min="0" step="1" class="form-control" id="spool_remaining_weight_g" placeholder="ex: 735">
            </div>
            <div class="col-md-4">
              <label class="form-label">AMS Tray</label>
              <input type="text" class="form-control" id="spool_ams_tray" placeholder="ex: A1, 2, ...">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" id="spool_location" placeholder="ex: Étagère 2 / Boîte verte">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tag NFC / UID</label>
              <input type="text" class="form-control" id="spool_tag_number" placeholder="ex: 04A3…">
            </div>
          </div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="spool_archived">
            <label class="form-check-label" for="spool_archived">Archiver cette bobine</label>
          </div>

          <div class="mt-3">
            <label class="form-label">Commentaire</label>
            <textarea class="form-control" id="spool_comment" rows="3"></textarea>
          </div>

          <div class="alert alert-danger mt-3 d-none" id="spoolError"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button class="btn btn-primary" id="spoolSaveBtn" onclick="saveSpool()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  let spoolModal = null;
  let filamentTS = null;

  function ensureTomSelect(selector, options){
    if (window.TomSelect){
      const el = document.querySelector(selector);
      if (!el) return null;
      if (el.tomselect) el.tomselect.destroy();
      return new TomSelect(selector, {
        create: false,
        persist: false,
        maxItems: 1,
        searchField: ['text', 'value'],
        sortField: { field: 'text', direction: 'asc' },
        options: options || [],
        render: {
          option: function(data, escape){ return `<div>${escape(data.text)}</div>`; },
          item:   function(data, escape){ return `<div>${escape(data.text)}</div>`; }
        }
      });
    } else {
      const sel = document.querySelector(selector);
      sel.innerHTML = '';
      (options || []).forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.text;
        sel.appendChild(opt);
      });
      return null;
    }
  }

  async function loadFilamentChoices(){
    const res = await fetch('/api/filaments/choices');
    const data = await res.json();
    if (!data.ok) throw new Error(data.message || 'Erreur /api/filaments/choices');
    return data.choices || [];
  }

  function showSpoolError(msg){
    const el = document.getElementById('spoolError');
    if (!el) return;
    el.textContent = msg || 'Erreur.';
    el.classList.remove('d-none');
  }
  function clearSpoolError(){
    const el = document.getElementById('spoolError');
    if (!el) return;
    el.textContent = '';
    el.classList.add('d-none');
  }

  window.openSpoolModal = async function(spool, opts){
    clearSpoolError();
    opts = opts || {};

    if (!spoolModal){
      const el = document.getElementById('spoolModal');
      if (!el) return;
      spoolModal = bootstrap.Modal.getOrCreateInstance(el);
    }

    const form = document.getElementById('spoolForm');
    if (form) form.reset();
    (document.getElementById('spool_id') || {}).value = (spool && spool.id) || '';

    try {
      const choices = await loadFilamentChoices();
      filamentTS = ensureTomSelect('#spool_filament_id', choices);
      const selected = (spool && spool.filament_id) || opts.filament_id || null;
      if (filamentTS){
        filamentTS.clear();
        if (selected) filamentTS.addItem(String(selected), true);
      } else {
        const sel = document.getElementById('spool_filament_id');
        if (sel) sel.value = selected || '';
      }
    } catch (e){
      return showSpoolError(e && e.message ? e.message : e);
    }

    const set = (id, val) => { const el = document.getElementById(id); if (el!=null && val!=null) el.value = val; };
    set('spool_price', (spool && spool.price_override) || '');
    set('spool_remaining_weight_g', (spool && spool.remaining_weight_g) || '');
    set('spool_ams_tray', (spool && spool.ams_tray) || '');
    set('spool_location', (spool && spool.location) || '');
    set('spool_tag_number', (spool && spool.tag_number) || '');
    set('spool_comment', (spool && spool.comment) || '');
    const arch = document.getElementById('spool_archived');
    if (arch) arch.checked = !!(spool && spool.archived);

    if (opts.comment_if_empty){
      const c = document.getElementById('spool_comment');
      if (c && !c.value) c.value = opts.comment_if_empty;
    }

    const title = document.getElementById('spoolModalLabel');
    if (title) title.textContent = (spool && spool.id) ? 'Modifier la bobine' : 'Créer une bobine';

    spoolModal.show();
  };

  window.openSpoolModalForFilament = function(fil){
    const txt = `Bobine créée pour ${(fil && fil.manufacturer) || ''} ${(fil && fil.material) || ''} • ${(fil && fil.name) || ''}`.trim();
    window.openSpoolModal(null, {
      filament_id: fil && fil.id,
      comment_if_empty: txt
    });
  };

  window.saveSpool = async function(){
    clearSpoolError();
    const id = (document.getElementById('spool_id') || {}).value || null;

    const filament_id = (filamentTS && filamentTS.getValue)
      ? filamentTS.getValue()
      : (document.getElementById('spool_filament_id') || {}).value;

    if (!filament_id) return showSpoolError("Choisis un filament.");

    const payload = {
      filament_id: Number(filament_id),
      price_override: (document.getElementById('spool_price') || {}).value || null,
      remaining_weight_g: (document.getElementById('spool_remaining_weight_g') || {}).value || null,
      location: (document.getElementById('spool_location') || {}).value || null,
      tag_number: (document.getElementById('spool_tag_number') || {}).value || null,
      ams_tray: (document.getElementById('spool_ams_tray') || {}).value || null,
      archived: !!((document.getElementById('spool_archived') || {}).checked),
      comment: (document.getElementById('spool_comment') || {}).value || null,
    };

    const p = (payload.price_override||'').toString().trim();
    if (p && isNaN(Number(p.replace(',', '.')))) {
      return showSpoolError('Le prix doit être un nombre (ex: 24.90).');
    }

    try{
      const resp = await fetch(id ? `/api/spools/${id}` : '/api/spools', {
        method: id ? 'PUT' : 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok){
        return showSpoolError((data && data.message) || "Erreur lors de l'enregistrement.");
      }
      window.location.reload();
    } catch (e){
      showSpoolError("Erreur réseau : " + (e && e.message ? e.message : e));
    }
  };
})();
</script>