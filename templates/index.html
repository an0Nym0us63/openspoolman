{% extends 'base.html' %}
{% block content %}

{% if printer_status %}
<div x-data="{ open: false }" class="mb-6">
  <!-- Accordéon du statut -->
  <div
    class="relative overflow-hidden shadow-md cursor-pointer transition-all duration-200"
    :class="open ? 'rounded-t-xl rounded-b-none bg-gray-900' : 'rounded-xl bg-gray-900'"
    @click="open = !open"
  >
    {% set progress_color = 'from-green-500 to-blue-500' %}
    {% if printer_status.status == 'FINISH' %}
      {% set progress_color = 'from-green-600 to-emerald-400' %}
    {% elif printer_status.status in ['ERROR', 'FAILED'] %}
      {% set progress_color = 'from-red-600 to-pink-500' %}
    {% elif printer_status.status == 'PAUSE' %}
      {% set progress_color = 'from-yellow-400 to-yellow-600' %}
    {% endif %}

    <div class="absolute inset-0 flex">
      <div id="status-progress-bar" class="h-full bg-gradient-to-r {{ progress_color }} transition-all duration-700"
           style="width: {{ printer_status.progress or 0 }}%; min-width: 2rem;"></div>
      <div class="flex-1 bg-gray-700"></div>
    </div>

    <div class="relative z-10 grid grid-cols-3 items-center text-white px-3 py-2 gap-2 text-xs sm:text-sm">
      <div class="flex items-center gap-2 truncate">
        <img id="status-thumbnail"
             src="{{ url_for('static', filename='prints/' ~ printer_status.thumbnail) if printer_status.thumbnail else url_for('static', filename='img/placeholder.png') }}"
             alt="thumbnail"
             class="w-10 h-10 sm:w-12 sm:h-12 object-cover rounded shadow" />
      </div>
      <div class="text-center font-semibold">
        <div id="status-progress">{{ printer_status.progress or 0 }}%</div>
        <div id="status-text" class="text-xs text-gray-300">{{ printer_status.status or '...' }}</div>
      </div>
      <div class="text-right text-xs">
        <div id="status-remaining">
          ⏱️ {{ printer_status.remaining_time_str }}<br>
          🗓️ {{ printer_status.estimated_end or '' }}
        </div>
      </div>
    </div>
  </div>

  <!-- Détails -->
  <div x-show="open" x-transition class="bg-gray-900/90 border border-t-0 border-gray-700 shadow-inner p-4 text-sm text-white rounded-b-xl space-y-4 backdrop-blur">
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
      <div><strong>📄</strong> <span id="status-print-name">{{ printer_status.print_name or 'N/A' }}</span></div>
      <div><strong>🔥</strong> <span id="status-nozzle">{{ printer_status.nozzle_temp or '—' }}</span> °C</div>
      <div><strong>🛏️</strong> <span id="status-bed">{{ printer_status.bed_temp or '—' }}</span> °C</div>
      <div><strong>🌡️</strong> <span id="status-chamber">{{ printer_status.chamber_temp or '—' }}</span> °C</div>
      <div><strong>🧱️</strong> <span id="status-layers">{{ printer_status.print_layer }}/{{ printer_status.total_layers }}</span></div>
    </div>
  </div>
</div>
{% endif %}

<!-- Alerte -->
{% if issue %}
<div class="rounded-xl border border-yellow-500 bg-yellow-200 text-yellow-900 p-4 shadow mb-6">
  <div class="font-bold text-sm mb-1">⚠️ Problème de synchronisation</div>
  <p class="text-sm">Corrige en cliquant sur "Fix this tray" sur les bobines signalées avec <i class="bi bi-exclamation-circle text-danger"></i></p>
</div>
{% endif %}

<!-- Cartes AMS & Externe -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

  <!-- Cartes AMS -->
  {% for ams in ams_data %}
  <div
    id="ams-card-{{ ams.id|string }}"
    class="rounded-xl overflow-hidden border border-gray-700 shadow-md hover:border-primary transition backdrop-blur-sm"
    style="background: linear-gradient(135deg, rgba(30,30,30,0.85), rgba(40,40,40,0.85));"
  >
    <!-- En-tête AMS -->
    <div class="flex justify-between items-start px-4 py-2 bg-gray-800 border-b border-gray-700">
      <span class="inline-flex items-center gap-2 bg-primary text-white text-sm font-semibold px-3 py-1 rounded-full shadow">
        {% if ams.location %}
          {{ ams.location }}
        {% else %}
          AMS{% if ams_data|length > 1 %} {{ ams.id|int + 1 }}{% endif %}
        {% endif %}
      </span>

      {% if ams.temp != "0.0" %}
      <div class="text-xs text-gray-300 flex flex-col items-end space-y-1">
        <div class="flex items-center gap-1">
          <i class="bi bi-droplet-half text-cyan-400"></i>{{ ams.humidity_raw }}%
        </div>
        <div class="flex items-center gap-1">
          <i class="bi bi-thermometer-half text-orange-300"></i>{{ ams.temp }}°C
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Bobines -->
    <div class="p-3 bg-gray-900 text-white">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {% for tray in ams.tray %}
          {% with tray_data=tray, ams_id=ams.id, pick_tray=False, tray_id=tray.id %}
            {% include 'fragments/tray.html' %}
          {% endwith %}
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- Spool externe -->
  <div
    id="ams-card-external"
    class="rounded-xl overflow-hidden border border-gray-700 shadow-md hover:border-primary transition backdrop-blur-sm"
    style="background: linear-gradient(135deg, rgba(30,30,30,0.85), rgba(40,40,40,0.85));"
  >
    <div class="flex justify-between items-start px-4 py-2 bg-gray-800 border-b border-gray-700">
      <span class="inline-flex items-center gap-2 bg-primary text-white text-sm font-semibold px-3 py-1 rounded-full shadow">
        External
      </span>
    </div>

    <div class="p-3 bg-gray-900 text-white">
      <div class="grid grid-cols-1 justify-center">
        {% with tray_data=vt_tray_data, ams_id=EXTERNAL_SPOOL_AMS_ID, pick_tray=False, tray_id=EXTERNAL_SPOOL_ID %}
          {% include 'fragments/tray.html' %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
