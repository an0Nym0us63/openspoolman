{% extends 'base.html' %}

{% block content %}
{% if printer_status %}
<div x-data="{ open: false }" class="mb-4">

  <!-- Header de l'accordéon -->
  <div
    class="tw-relative tw-overflow-hidden tw-shadow-md tw-cursor-pointer tw-transition-all tw-duration-200"
    :class="open ? 'tw-rounded-t-xl tw-rounded-b-none tw-bg-gray-900' : 'tw-rounded-xl tw-bg-gray-900'"
    @click="open = !open"
  >
    {% set progress_color = 'tw-from-green-500 tw-to-blue-500' %}
    {% if printer_status.status == 'FINISH' %}
      {% set progress_color = 'tw-from-green-600 tw-to-emerald-400' %}
    {% elif printer_status.status == 'ERROR' or printer_status.status == 'FAILED' %}
      {% set progress_color = 'tw-from-red-600 tw-to-pink-500' %}
    {% elif printer_status.status == 'PAUSE' %}
      {% set progress_color = 'tw-from-yellow-400 tw-to-yellow-600' %}
    {% endif %}

    <div class="tw-absolute tw-inset-0 tw-flex">
      <div id="status-progress-bar" class="tw-h-full tw-bg-gradient-to-r {{ progress_color }} tw-transition-all tw-duration-700"
           style="width: {{ printer_status.progress or 0 }}%; min-width: 2rem;"></div>
      <div class="tw-flex-1 tw-bg-gray-700"></div>
    </div>

    <div class="tw-relative tw-z-10 tw-grid tw-grid-cols-3 tw-items-center tw-text-white tw-px-3 tw-py-2 tw-gap-2 tw-text-xs sm:tw-text-sm">
      <div class="tw-flex tw-items-center tw-gap-2 tw-truncate">
        <img id="status-thumbnail" src="{{ url_for('static', filename='prints/' ~ printer_status.thumbnail) if printer_status.thumbnail else url_for('static', filename='img/placeholder.png') }}"
             alt="thumbnail" class="tw-w-10 tw-h-10 sm:tw-w-12 sm:tw-h-12 tw-object-cover tw-rounded tw-shadow" />
      </div>
      <div class="tw-text-center tw-font-semibold">
        <div id="status-progress">{{ printer_status.progress or 0 }}%</div>
        <div id="status-text" class="tw-text-xs tw-text-gray-300">{{ printer_status.status or '...' }}</div>
      </div>
      <div class="tw-text-right tw-text-xs">
        <div id="status-remaining">
          ⏱️ {{ printer_status.remaining_time_str }}<br>
          🗓️ {{ printer_status.estimated_end or '' }}
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu déplié -->
  <div x-show="open" x-transition class="tw-bg-gray-800 tw-border tw-border-t-0 tw-rounded-b-xl tw-shadow-inner tw-p-4 tw-text-sm tw-text-light tw-space-y-4">
    <div class="tw-grid tw-grid-cols-2 sm:tw-grid-cols-3 tw-gap-2">
      <div><strong>📄</strong> <span id="status-print-name">{{ printer_status.print_name or 'N/A' }}</span></div>
      <div><strong>🔥</strong> <span id="status-nozzle">{{ printer_status.nozzle_temp or '—' }}</span> °C</div>
      <div><strong>🛏️</strong> <span id="status-bed">{{ printer_status.bed_temp or '—' }}</span> °C</div>
      <div><strong>🌡️</strong> <span id="status-chamber">{{ printer_status.chamber_temp or '—' }}</span> °C</div>
      <div><strong>🩱️</strong> <span id="status-layers">{{ printer_status.print_layer }}/{{ printer_status.total_layers }}</span></div>
    </div>
  </div>
</div>
{% endif %}

<!-- Alpine.js requis -->
<script src="https://unpkg.com/alpinejs" defer></script>

<script>
  function updateHighlighting(tray_ams_id, tray_local_id) {
    const trayKey = `${String(tray_ams_id)}_${String(tray_local_id)}`;
    const amsKey = String(tray_ams_id);

    document.querySelectorAll('[id^="ams-card-"]').forEach(card => {
      card.classList.remove('border', 'border-4', 'border-primary');
    });
    const amsCard = document.querySelector(`#ams-card-${amsKey}`);
    if (amsCard) {
      amsCard.classList.add('border', 'border-4', 'border-primary');
    }

    document.querySelectorAll('[id^="tray-card-"]').forEach(card => {
      card.classList.remove('border', 'border-3', 'border-warning', 'shadow-lg');
    });
    const trayCard = document.querySelector(`#tray-card-${trayKey}`);
    if (trayCard) {
      trayCard.classList.add('border', 'border-3', 'border-warning', 'shadow-lg');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    async function refreshPrinterStatus() {
      try {
        const res = await fetch('/printer_status');
        if (!res.ok) return;

        const data = await res.json();

        document.getElementById('status-progress').innerText = `${data.progress || 0}%`;
        document.getElementById('status-text').innerText = data.status || '...';
        document.getElementById('status-progress-bar').style.width = `${data.progress || 0}%`;

        const bar = document.getElementById('status-progress-bar');
        bar.classList.remove('tw-from-green-500', 'tw-to-blue-500', 'tw-from-green-600', 'tw-to-emerald-400', 'tw-from-red-600', 'tw-to-pink-500', 'tw-from-yellow-400', 'tw-to-yellow-600');
        if (data.status === 'FINISH') {
          bar.classList.add('tw-from-green-600', 'tw-to-emerald-400');
        } else if (data.status === 'ERROR' || data.status === 'FAILED') {
          bar.classList.add('tw-from-red-600', 'tw-to-pink-500');
        } else if (data.status === 'PAUSE') {
          bar.classList.add('tw-from-yellow-400', 'tw-to-yellow-600');
        } else {
          bar.classList.add('tw-from-green-500', 'tw-to-blue-500');
        }

        if (data.remaining_time_str || data.estimated_end) {
          document.getElementById('status-remaining').innerHTML =
            `⏱️ ${data.remaining_time_str}<br>🗓️ ${data.estimated_end}`;
        } else {
          document.getElementById('status-remaining').innerHTML = '';
        }

        document.getElementById('status-layers').innerText = data.print_layer && data.total_layers ? `${data.print_layer}/${data.total_layers}` : '';

        document.getElementById('status-nozzle').innerText = data.nozzle_temp || '—';
        document.getElementById('status-bed').innerText = data.bed_temp || '—';
        document.getElementById('status-chamber').innerText = data.chamber_temp || '—';

        if (data.print_name && document.getElementById('status-print-name')) {
          document.getElementById('status-print-name').innerText = data.print_name;
        }

        if (data.thumbnail && document.getElementById('status-thumbnail')) {
          document.getElementById('status-thumbnail').src = `/static/prints/${data.thumbnail}`;
        }

        if (data.tray_ams_id != null && data.tray_local_id != null) {
          updateHighlighting(data.tray_ams_id, data.tray_local_id);
        }

      } catch (e) {
        console.error('Erreur mise à jour printer_status:', e);
      }
    }

    refreshPrinterStatus();
    const interval = setInterval(refreshPrinterStatus, 5000);
    window.addEventListener('beforeunload', () => clearInterval(interval));
  });
</script>
{% endblock %}
