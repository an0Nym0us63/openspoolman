{% extends "base.html" %}
{% block content %}
<div class="container my-4">

  <!-- Filtres de p√©riode -->
  <form method="get" class="d-flex justify-content-center mb-4 flex-wrap gap-2">
    {% for key, label in {
      'all': 'Tout',
      'day': '24h',
      '7d': '7j',
      '1m': '1m',
      '1y': '1a'
    }.items() %}
      <button type="submit" name="period" value="{{ key }}"
              class="btn btn-sm {% if selected_period == key %}btn-primary{% else %}btn-outline-secondary{% endif %}">
        {{ label }}
      </button>
    {% endfor %}
  </form>

  <!-- Statistiques -->
  <div class="row g-3">
    {% set cards = [
      ('üñ®', stats.total_prints),
      ('‚è±', stats.total_duration | default(0) | round(1)),
      ('‚öñÔ∏è', stats.total_weight | default(0) | round(1)),
      ('üí∞', stats.filament_cost | default(0) | round(2)),
      ('‚ö°', stats.electric_cost | default(0) | round(2)),
      ('üíµ', stats.total_cost | default(0) | round(2))
    ] %}

    {% for label, value in cards %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title small text-muted">{{ label }}</h6>
          <p class="card-text fs-5 fw-bold">
  {% if 'üí∞' in label or '‚ö°' in label or 'üíµ' in label %}
    {{ value }} {{ currencysymbol }}
  {% elif '‚öñÔ∏è' in label %}
    {% if value >= 1000 %}
      {{ (value / 1000) | round(2) }} kg
    {% else %}
      {{ value }} g
    {% endif %}
  {% elif '‚è±' in label %}
    {{ value }} h
  {% else %}
    {{ value }}
  {% endif %}
</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="my-4">
  <h6 class="text-center text-muted">R√©partition par type de filament</h6>
  <div class="ratio ratio-1x1 mx-auto" style="max-width: 400px;">
    <canvas id="filamentTypePieChart"></canvas>
  </div>
</div>
  <div class="my-4">
  <h6 class="text-center text-muted">R√©partition par marque</h6>
  <div class="ratio ratio-1x1 mx-auto" style="max-width: 400px;">
    <canvas id="vendorPieChart"></canvas>
  </div>
</div>
<div class="my-4">
  <h6 class="text-center text-muted">R√©partition par couleur</h6>
  <div class="ratio ratio-1x1 mx-auto" style="max-width: 400px;">
    <canvas id="colorFamilyPieChart"></canvas>
  </div>
</div>
<div class="my-4">
  <h6 class="text-center text-muted">R√©partition des dur√©es d‚Äôimpression</h6>
  <div class="ratio ratio-16x9">
    <canvas id="durationHistogram"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctxVendor = document.getElementById('vendorPieChart').getContext('2d');
  new Chart(ctxVendor, {
    type: 'pie',
    data: {
      labels: {{ stats.vendor_pie["labels"]|tojson }},
      datasets: [{
        data: {{ stats.vendor_pie["values"]|tojson }},
        backgroundColor: [
          '#4e79a7', '#f28e2b', '#e15759', '#76b7b2',
          '#59a14f', '#edc948', '#b07aa1', '#ff9da7',
          '#9c755f', '#bab0ac'
        ]
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              if (value >= 1000) {
                return `${label}: ${(value / 1000).toFixed(1)} kg`;
              } else {
                return `${label}: ${value.toFixed(1)} g`;
              }
            }
          }
        }
      }
    }
  });
  
  const ctxDuration = document.getElementById('durationHistogram').getContext('2d');
  new Chart(ctxDuration, {
    type: 'bar',
    data: {
      labels: {{ stats.duration_histogram["labels"]|tojson }},
      datasets: [{
        label: 'Nombre d‚Äôimpressions',
        data: {{ stats.duration_histogram["values"]|tojson }},
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Nombre d‚Äôimpressions'
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
  
   const ctxFilamentType = document.getElementById('filamentTypePieChart').getContext('2d');
  new Chart(ctxFilamentType, {
    type: 'pie',
    data: {
      labels: {{ stats.filament_type_pie["labels"]|tojson }},
      datasets: [{
        data: {{ stats.filament_type_pie["values"]|tojson }},
        backgroundColor: [
          '#4e79a7', '#f28e2b', '#e15759', '#76b7b2',
          '#59a14f', '#edc948', '#b07aa1', '#ff9da7',
          '#9c755f', '#bab0ac'
        ]
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let value = context.parsed;
              return value >= 1000
                ? (value / 1000).toFixed(1) + ' kg'
                : value.toFixed(1) + ' g';
            }
          }
        }
      }
    }
  });
  const colorFamilyLabels = {{ stats.color_family_pie["labels"]|tojson }};
  const colorFamilyValues = {{ stats.color_family_pie.["values"]|tojson }};

  const colorFamilyToHex = {
    'Noir': '#000000',
    'Blanc': '#FFFFFF',
    'Gris': '#A0A0A0',
    'Rouge': '#DC143C',
    'Orange': '#FF8C00',
    'Jaune': '#FFDC00',
    'Vert': '#50C878',
    'Bleu': '#6496FF',
    'Violet': '#A020F0',
    'Marron': '#964B00'
  };

  const backgroundColors = colorFamilyLabels.map(label => colorFamilyToHex[label] || '#CCCCCC');

  const ctxColor = document.getElementById('colorFamilyPieChart').getContext('2d');
  new Chart(ctxColor, {
    type: 'pie',
    data: {
      labels: colorFamilyLabels,
      datasets: [{
        data: colorFamilyValues,
        backgroundColor: backgroundColors
      }]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              return `${context.label}: ${value >= 1000 ? (value / 1000).toFixed(1) + ' kg' : value.toFixed(1) + ' g'}`;
            }
          }
        },
        legend: {
          position: 'bottom'
        }
      }
    }
  });
</script>
</div>

{% endblock %}