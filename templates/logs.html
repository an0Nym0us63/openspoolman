{% extends "base.html" %}
{% block content %}
<div class="container my-4" style="max-width: 1100px;">

  <!-- Toolbar -->
  <div class="card bg-dark border-secondary mb-3" id="logs-toolbar">
    <div class="card-body">
      <form id="controls" class="row row-cols-1 row-cols-sm-auto g-2 align-items-center">
        <div class="col">
          <label class="col-form-label text-light control-label" for="level">Niveau</label>
          <select id="level" class="form-select">
            <option>DEBUG</option>
            <option selected>INFO</option>
            <option>WARNING</option>
            <option>ERROR</option>
            <option>CRITICAL</option>
          </select>
        </div>

        <div class="col">
          <label class="col-form-label text-light control-label" for="q">Filtre (regex)</label>
          <input id="q" type="text" class="form-control" placeholder="ex: (nozzle|MQTT|ERROR)">
        </div>

        <div class="col d-flex gap-2 align-items-end">
          <button type="button" id="apply" class="btn btn-primary">
            <i class="bi bi-funnel"></i> Appliquer
          </button>
          <button type="button" id="pause" class="btn btn-outline-warning">
            ‚è∏Ô∏è Pause
          </button>
          <button type="button" id="clear" class="btn btn-outline-danger">
            üßπ Clear
          </button>
          <div class="form-check ms-2">
            <input class="form-check-input" type="checkbox" id="autoscroll" checked>
            <label class="form-check-label text-light" for="autoscroll">Auto‚Äëscroll</label>
          </div>
        </div>

        <div class="col ms-auto text-secondary small">
          <span id="stats">‚Äî</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Zone logs -->
  <div class="card bg-black border-secondary">
    <div id="logs" class="card-body font-monospace"
         style="white-space: pre-wrap; line-height: 1.2; min-height: 50vh; max-height: 70vh; overflow: auto;">

      <!-- lignes ins√©r√©es ici -->

    </div>
  </div>
</div>

<style>
  /* Couleurs par niveau */
  .log-line       { margin: 2px 0; opacity: 0; animation: fadeIn 200ms ease-out forwards; }
  .lvl-DEBUG      { color: #00bcd4; }
  .lvl-INFO       { color: #8bc34a; }
  .lvl-WARNING    { color: #ffc107; }
  .lvl-ERROR      { color: #ff5252; font-weight: 600; }
  .lvl-CRITICAL   { color: #ff1744; font-weight: 700; text-decoration: underline; }

  .ts             { color: #9e9e9e; margin-right: .5rem; }
  .logger.badge   { background: #2b2b2b; border: 1px solid #444; color: #cfcfcf; }

  /* S√©parateur de date (changement de jour) */
  .day-sep { color:#bdbdbd; border-top:1px dashed #555; margin:.5rem 0 .5rem; padding-top:.3rem; font-size:.9rem; }

  /* Highlight court pour nouvelles lignes */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .flash { animation: flashBg 1200ms ease-out 1; }
  @keyframes flashBg {
    0%   { background: rgba(255,255,255,.06); }
    100% { background: transparent; }
  }

  .control-label { font-size: .9rem; }
</style>

<script>
(() => {
  const logEl       = document.getElementById('logs');
  const levelEl     = document.getElementById('level');
  const qEl         = document.getElementById('q');
  const applyBtn    = document.getElementById('apply');
  const pauseBtn    = document.getElementById('pause');
  const clearBtn    = document.getElementById('clear');
  const statsEl     = document.getElementById('stats');
  const autoscrollCk= document.getElementById('autoscroll');

  // Regex pour parser le format:
  // "YYYY-MM-DD HH:MM:SS,mmm [LEVEL] logger: message"
  const LINE_RE = /^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d{3})\s+\[(\w+)\]\s+([^:]+):\s*(.*)$/;

  let lastId   = 0;
  let paused   = false;
  let timer    = null;
  let lastDay  = null;
  let rendered = 0;

  function dayKey(tsStr) {
    // prend "2025-08-14 12:34:56,123" -> "2025-08-14"
    return tsStr ? tsStr.substring(0, 10) : "";
  }

  function addDaySeparatorIfNeeded(tsStr) {
    const dk = dayKey(tsStr);
    if (!dk) return;
    if (lastDay !== dk) {
      lastDay = dk;
      const sep = document.createElement('div');
      sep.className = 'day-sep';
      sep.textContent = `‚Äî ${dk} ‚Äî`;
      logEl.appendChild(sep);
    }
  }

  function renderLine(raw) {
    // Fallback : si la ligne ne matche pas, on la rend brute
    const m = raw.match(LINE_RE);

    if (!m) {
      const div = document.createElement('div');
      div.className = 'log-line lvl-INFO flash';
      div.textContent = raw;
      logEl.appendChild(div);
      return;
    }

    const [, ts, level, logger, msg] = m;

    addDaySeparatorIfNeeded(ts);

    const div = document.createElement('div');
    div.className = `log-line lvl-${level} flash`;

    const spanTs = document.createElement('span');
    spanTs.className = 'ts';
    spanTs.textContent = ts;

    const badge = document.createElement('span');
    badge.className = 'badge rounded-pill logger me-2';
    badge.textContent = logger;

    const spanLvl = document.createElement('span');
    spanLvl.className = 'me-2';
    spanLvl.textContent = `[${level}]`;

    const spanMsg = document.createElement('span');
    spanMsg.textContent = msg;

    div.appendChild(spanTs);
    div.appendChild(spanLvl);
    div.appendChild(badge);
    div.appendChild(spanMsg);

    logEl.appendChild(div);
  }

  function poll() {
    if (paused) return;
    const params = new URLSearchParams({
      since: String(lastId || 0),
      level: levelEl.value || 'INFO',
      q: qEl.value || ''
    });
    fetch(`/logs/poll?${params.toString()}`, { cache: 'no-store' })
      .then(r => r.json())
      .then(({lines, last}) => {
        if (Array.isArray(lines) && lines.length) {
          for (const line of lines) renderLine(line);
          rendered += lines.length;
          lastId = last || lastId;
          statsEl.textContent = `${rendered} ligne(s) affich√©e(s) ‚Äì last=${lastId}`;
          if (autoscrollCk.checked) {
            logEl.scrollTop = logEl.scrollHeight;
          }
        }
      })
      .catch(() => {/* silence */});
  }

  function start() {
    stop();
    poll();
    timer = setInterval(poll, 900);
  }

  function stop() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  applyBtn.addEventListener('click', () => {
    // reset pagination & rendu
    lastId = 0;
    rendered = 0;
    logEl.textContent = '';
    lastDay = null;
    poll();
  });

  pauseBtn.addEventListener('click', () => {
    paused = !paused;
    pauseBtn.textContent = paused ? "‚ñ∂Ô∏è Reprendre" : "‚è∏Ô∏è Pause";
  });

  clearBtn.addEventListener('click', () => {
    logEl.textContent = '';
    rendered = 0;
    lastDay = null;
  });

  // Lancement
  start();
  window.addEventListener('beforeunload', stop);
})();
</script>
{% endblock %}
