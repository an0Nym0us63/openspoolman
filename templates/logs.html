{% extends "base.html" %}
{% block content %}
<div class="container my-4" style="max-width: 1100px;">

  <!-- Toolbar -->
  <div class="card bg-dark border-secondary mb-3" id="logs-toolbar">
    <div class="card-body">
      <form id="controls" class="row row-cols-1 row-cols-sm-auto g-2 align-items-center">
        <div class="col">
          <label class="col-form-label text-light control-label" for="level">Niveau</label>
          <select id="level" class="form-select">
            <option>DEBUG</option>
            <option selected>INFO</option>
            <option>WARNING</option>
            <option>ERROR</option>
            <option>CRITICAL</option>
          </select>
        </div>

        <div class="col">
          <label class="col-form-label text-light control-label" for="q">Filtre (regex)</label>
          <input id="q" type="text" class="form-control" placeholder="ex: (nozzle|MQTT|ERROR)">
        </div>

        <div class="col d-flex gap-2 align-items-end">
          <button type="button" id="apply" class="btn btn-primary">
            <i class="bi bi-funnel"></i> Appliquer
          </button>
          <button type="button" id="pause" class="btn btn-outline-warning">
            ‚è∏Ô∏è Pause
          </button>
          <button type="button" id="clear" class="btn btn-outline-danger">
            üßπ Clear
          </button>
          <div class="form-check ms-2">
            <input class="form-check-input" type="checkbox" id="autoscroll" checked>
            <label class="form-check-label text-light" for="autoscroll">Auto‚Äëscroll</label>
          </div>
        </div>

        <div class="col ms-auto text-secondary small">
          <span id="stats">‚Äî</span>
        </div>
      </form>
    </div>
  </div>

  <!-- Zone logs -->
  <div class="card bg-black border-secondary">
    <div id="logs" class="card-body font-monospace"
     style="white-space: pre-wrap; line-height: 1.2; min-height: 50vh; max-height: 70vh; overflow: auto;">
  <div id="placeholder" class="text-secondary">En attente de donn√©es‚Ä¶</div>
</div>
  </div>
</div>
<style>
  .log-line     { margin: 2px 0; opacity: 0; animation: fadeIn 150ms ease-out forwards; }
  .lvl-DEBUG    { color: #00bcd4; }
  .lvl-INFO     { color: #8bc34a; }
  .lvl-WARNING  { color: #ffc107; }
  .lvl-ERROR    { color: #ff5252; font-weight: 600; }
  .lvl-CRITICAL { color: #ff1744; font-weight: 700; text-decoration: underline; }
  .ts           { color: #9e9e9e; margin-right: .5rem; }
  .logger.badge { background: #2b2b2b; border: 1px solid #444; color: #cfcfcf; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .flash { animation: flashBg 1200ms ease-out 1; }
  @keyframes flashBg { 0% { background: rgba(255,255,255,.06);} 100%{ background: transparent;} }
  #logs { color: #e0e0e0; }             /* couleur par d√©faut lisible */
#logs .log-line, #logs .log-line * { color: inherit; }

</style>
<script>
(() => {
  const logEl        = document.getElementById('logs');
  const placeholder  = document.getElementById('placeholder');
  const levelEl      = document.getElementById('level');
  const filterInput  = document.getElementById('filter') || document.getElementById('q'); // compat
  const applyBtn     = document.getElementById('apply');
  const pauseBtn     = document.getElementById('pause');
  const clearBtn     = document.getElementById('clear');
  const autoscrollCk = document.getElementById('autoscroll');

  // Format back‚Äëend : "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
  // Exemple typique : "2025-08-14 12:34:56,123 [INFO] mqtt_bambulab: Ready"
  // Regex tol√©rante : millis optionnels, espaces tol√©rants, name jusqu'√† ':'
  const LINE_RE = /^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:[.,]\d{3})?)\s+\[(\w+)\]\s+([^:]+):\s*(.*)$/;

  let last   = 0;
  let paused = false;
  let timer  = null;

  function removePlaceholderOnce() {
    if (placeholder && placeholder.parentNode) {
      placeholder.remove();
    }
  }

  function classForLevel(level) {
    return `lvl-${(level || 'INFO').toUpperCase()}`;
  }

  function renderRawLine(raw, levelHint = 'INFO') {
    const div = document.createElement('div');
    div.className = `log-line ${classForLevel(levelHint)} flash`;
    div.textContent = raw;
    logEl.appendChild(div);
  }

  function renderLine(raw) {
  try {
    const m = raw.match(LINE_RE);
    if (!m) {
      renderRawLine(raw, 'INFO');
      return;
    }

    const [, ts, level, logger, msg] = m;

    const div = document.createElement('div');
    div.className = `log-line ${classForLevel(level)} flash`;

    const spanTs = document.createElement('span');
    spanTs.className = 'ts';
    spanTs.textContent = ts;

    const spanLvl = document.createElement('span');
    spanLvl.className = 'me-2';
    spanLvl.textContent = `[${level}]`;

    const badge = document.createElement('span');
    badge.className = 'badge rounded-pill logger me-2';
    badge.textContent = logger;

    const spanMsg = document.createElement('span');
    spanMsg.textContent = msg;

    // IMPORTANT: tout est ajout√© au div avant l‚Äôinsertion
    div.appendChild(spanTs);
    div.appendChild(spanLvl);
    div.appendChild(badge);
    div.appendChild(spanMsg);

    logEl.appendChild(div);

    // Sanity check: si jamais le div est vide, on bascule en affichage brut
    if (!div.firstChild) {
      console.warn('[logs] div rendu vide, fallback en brut:', raw);
      logEl.removeChild(div);
      renderRawLine(raw, level);
    }
  } catch (e) {
    console.error('[logs] renderLine error:', e, 'raw=', raw);
    renderRawLine(raw, 'INFO');
  }
}


  async function pollOnce() {
    const params = new URLSearchParams();
    params.set('since', String(last || 0));
    params.set('level', (levelEl && levelEl.value) ? levelEl.value : 'INFO');
    const qVal = filterInput && filterInput.value ? filterInput.value.trim() : '';
    if (qVal) params.set('q', qVal);

    let res;
    try {
      res = await fetch('/logs/poll?' + params.toString(), { cache: 'no-store' });
    } catch (e) {
      removePlaceholderOnce();
      renderRawLine(`(poll error r√©seau) ${e}`, 'ERROR');
      return;
    }

    if (!res.ok) {
      removePlaceholderOnce();
      renderRawLine(`(poll HTTP ${res.status})`, 'ERROR');
      return;
    }

    let payload;
    try {
      payload = await res.json();
    } catch (e) {
      removePlaceholderOnce();
      renderRawLine(`(poll JSON invalide) ${e}`, 'ERROR');
      return;
    }

    const { lines, last: newLast } = payload || {};
    if (Array.isArray(lines) && lines.length) {
      removePlaceholderOnce();
      for (const line of lines) renderLine(line);
      last = (typeof newLast === 'number') ? newLast : last;
      if (autoscrollCk && autoscrollCk.checked) {
        logEl.scrollTop = logEl.scrollHeight;
      }
    }
  }

  function start() {
    stop();
    pollOnce();
    timer = setInterval(() => { if (!paused) pollOnce(); }, 900);
  }

  function stop() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  // Controls
  if (applyBtn) {
    applyBtn.addEventListener('click', () => { last = 0; logEl.textContent = ''; start(); });
  }
  if (pauseBtn) {
    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      pauseBtn.textContent = paused ? '‚ñ∂Ô∏è Reprendre' : '‚è∏Ô∏è Pause';
    });
  }
  if (clearBtn) {
    clearBtn.addEventListener('click', () => { logEl.textContent = ''; });
  }

  start();
  window.addEventListener('beforeunload', stop);
})();
</script>
{% endblock %}
