{% extends 'base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* Thème sombre pour Select2 */
.select2-container .select2-dropdown {
  background-color: #212529;
  color: #fff;
  border-color: #444;
}

.select2-container .select2-results__option {
  color: #fff;
}

.select2-container .select2-results__option--highlighted {
  background-color: #343a40;
}

/* Sélection multiple thème sombre + amélioré */
.select2-container--default .select2-selection--multiple {
  background-color: #212529;
  color: #fff;
  border: 1px solid #444;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice {
  display: flex;
  align-items: center;
  gap: 4px;
  background-color: #343a40;
  color: #fff;
  border: 1px solid #555;
  padding: 2px 6px;
  border-radius: 4px;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
  color: #ccc;
  margin-right: 4px;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
  color: #fff;
}
</style>

<script>
    function adjustPrintImages() {
        document.querySelectorAll('.print-grid').forEach(grid => {
            const printInfo = grid.querySelector('.printinfo');
            const printImageContainer = grid.querySelector('.print-image');
            const image = printImageContainer.querySelector('img');

            if (printInfo && printImageContainer) {
                const height = printInfo.clientHeight;
                printImageContainer.style.height = height + "px";
                if (image) {
                    image.style.height = "100%";
                    image.style.width = "auto";
                    image.style.objectFit = "contain";
                }
            }
        });
    }
    window.addEventListener("load", adjustPrintImages);
    window.addEventListener("resize", adjustPrintImages);
</script>

<h1 class="mb-4 text-center">Print History</h1>

<form method="get" class="mb-4">
  <div class="row gy-2">
    <div class="col-md-3">
      <label for="filament_type">Filament Type</label>
      <select name="filament_type" multiple class="form-select select2">
        {% for ft in distinct_values.filament_types %}
          <option value="{{ ft }}" {% if ft in filters.filament_type %}selected{% endif %}>{{ ft }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label for="color">Filament Color</label>
      <select name="color" multiple class="form-select select2">
        {% for family in distinct_values.colors %}
          <option value="{{ family }}" {% if family in filters.color %}selected{% endif %}>
            {{ family }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label for="search">File Name Contains</label>
      <input type="text" name="search" class="form-control" value="{{ search }}">
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </div>
</form>

{% with action_assign=True %}{% include 'fragments/list_prints.html' %}{% endwith %}

<div class="pagination justify-content-center mt-4">
  {% if page > 1 %}
    <a href="{{ url_with_args(page=page-1) }}" class="btn btn-primary">&laquo; Previous</a>
  {% endif %}
  <span class="mx-3">Page {{ page }} / {{ total_pages }}</span>
  {% if page < total_pages %}
    <a href="{{ url_with_args(page=page+1) }}" class="btn btn-primary">Next &raquo;</a>
  {% endif %}
</div>

<script>
$(document).ready(function () {
  $('select[name="color"]').select2({
    width: '100%',
    templateResult: formatColor,
    templateSelection: formatColor
  });
  $('select[name="filament_type"]').select2({
    width: '100%'
  });
});

const colorMap = {
  'Black': '#000000',
  'White': '#FFFFFF',
  'Red': '#FF0000',
  'Green': '#008000',
  'Blue': '#0000FF',
  'Yellow': '#FFFF00',
  'Orange': '#FFA500',
  'Purple': '#800080',
  'Pink': '#FFC0CB',
  'Brown': '#8B4513',
  'Grey': '#808080'
};

const colorNamesFR = {
  'Black': 'Noir',
  'White': 'Blanc',
  'Red': 'Rouge',
  'Green': 'Vert',
  'Blue': 'Bleu',
  'Yellow': 'Jaune',
  'Orange': 'Orange',
  'Purple': 'Violet',
  'Pink': 'Rose',
  'Brown': 'Marron',
  'Grey': 'Gris'
};

function formatColor(state) {
  if (!state.id) return state.text;
  const hex = colorMap[state.id] || '#000000';
  const fr = colorNamesFR[state.id] || state.text;
  return $(`
    <span style="display:flex;align-items:center;">
      <span style="
        display:inline-block;
        width:14px;
        height:14px;
        background:${hex};
        border:1px solid #ccc;
        margin-right:8px;
        border-radius:3px;
      "></span>
      ${fr}
    </span>`);
}
</script>
{% endblock %}
