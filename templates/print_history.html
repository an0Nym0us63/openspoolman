{% extends 'base.html' %}

{% block content %}

{% set query = [] %}
{% for k, vlist in args.items() %}
  {% for v in vlist %}
    {% set _ = query.append(k ~ '=' ~ v) %}
  {% endfor %}
{% endfor %}
{% set base_query = '&'.join(query) %}

<!-- Bouton flottant pagination -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button" data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas" aria-controls="paginationOffcanvas">
    üìÑ
  </button>
</div>

<!-- Bouton flottant filtres -->
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">
    üîç
  </button>
</div>

<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas" aria-labelledby="paginationOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="paginationOffcanvasLabel">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        <label for="gotoPage" class="me-1 mb-0"></label>
        <input type="number" min="1" max="{{ total_pages }}" id="gotoPage" name="page" value="{{ page }}" class="form-control form-control-sm" style="width: 40px;">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Offcanvas filtres -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel" style="height:60vh">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filtres</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get">
      <div class="row row-cols-1 row-cols-md-2 g-3">
        <div class="col">
          <label for="filament_type">Type de filament</label>
          <select name="filament_type" multiple class="form-select select2" data-placeholder="‚Äî Type de filament ‚Äî">
            {% for ft in distinct_values.filament_types %}
              <option value="{{ ft }}" {% if ft in filters.filament_type %}selected{% endif %}>{{ ft }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col">
          <label for="color">Couleur du filament</label>
          <select name="color" multiple class="form-select select2" data-placeholder="‚Äî Famille de couleur ‚Äî">
            {% for family in distinct_values.colors %}
              <option value="{{ family }}" {% if family in filters.color %}selected{% endif %}>{{ family }}</option>
            {% endfor %}
          </select>
        </div>
		
		<div class="col">
  <label for="filament_id">Filament</label>
  <select name="filament_id" class="form-select select2-filament" data-placeholder="‚Äî Tous les filaments ‚Äî">
  <option></option>
  {% for filament in distinct_values.filaments %}
    <option value="{{ filament.id }}"
            data-color="{{ filament.color }}"
            {% if filament.id|string == filters.filament_id|first %}selected{% endif %}>
      {{ filament.display_name }}
    </option>
  {% endfor %}
</select>
</div>

        <div class="col">
          <label for="search" class="form-label">Fichier ou tag</label>
          <input type="text" name="search" id="search" class="form-control" value="{{ search or '' }}">
        </div>

        <div class="col text-end align-self-end">
          <button type="submit" class="btn btn-primary">Appliquer</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% include 'fragments/list_prints.html' %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/print_history.js') }}"></script>
{% endblock %}
