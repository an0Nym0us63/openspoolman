{% extends 'base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* styles de thème sombre et select2 (inchangés) */
…
</style>

<h1 class="mb-4 text-center">Print History</h1>

<form method="get" class="mb-4">
  <div class="row gy-2">
    <div class="col-md-3">
      <label for="filament_type">Filament Type</label>
      <select name="filament_type" multiple class="form-select select2">
        {% for ft in distinct_values.filament_types %}
          <option value="{{ ft }}" {% if ft in filters.filament_type %}selected{% endif %}>{{ ft }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label for="color">Filament Color</label>
      <select name="color" multiple class="form-select select2">
        {% for family in distinct_values.colors %}
          <option value="{{ family }}" {% if family in filters.color %}selected{% endif %}>
            {{ family }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label for="search">File Name Contains</label>
      <input type="text" name="search" class="form-control" value="{{ search }}">
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </div>
</form>

{% with action_assign=True %}{% include 'fragments/list_prints.html' %}{% endwith %}

<div class="pagination justify-content-center mt-4">
  {% if page > 1 %}
    <a href="{{ url_with_args(page=page-1) }}" class="btn btn-primary">&laquo; Previous</a>
  {% endif %}
  <span class="mx-3">Page {{ page }} / {{ total_pages }}</span>
  {% if page < total_pages %}
    <a href="{{ url_with_args(page=page+1) }}" class="btn btn-primary">Next &raquo;</a>
  {% endif %}
</div>

<script>
$(document).ready(function () {
  $('select[name=\"color\"]').select2({
    width: '100%'
  });
  $('select[name=\"filament_type\"]').select2({
    width: '100%'
  });
});

// SweetAlert2 actions
function confirmReajust(printId) {
    askRestockRatioPerFilament(printId, false);
}

function confirmDelete(printId) {
    askRestockRatioPerFilament(printId, true);
}

function askRestockRatioPerFilament(printId, isDelete) {
    fetch(`/history/${printId}/filaments`)
    .then(resp => resp.json())
    .then(filaments => {
        const formHtml = filaments.map(f => `
            <div style=\"display:flex;align-items:center;margin-bottom:5px;gap:5px\">
                <div style=\"width:15px;height:15px;background:${f.color};border:1px solid #ccc\"></div>
                <span style=\"flex:1\">${f.name}</span>
                <input type=\"number\" min=\"0\" max=\"100\" value=\"100\" id=\"ratio_${f.spool_id}\" style=\"width:60px\"> %
            </div>
        `).join(\"\");

        Swal.fire({
            title: isDelete ? \"Supprimer + Réajuster\" : \"Réajuster uniquement\",
            html: formHtml,
            showCancelButton: true,
            confirmButtonText: \"Valider\",
            cancelButtonText: \"Annuler\",
            preConfirm: () => {
                const ratios = {};
                filaments.forEach(f => {
                    const val = parseInt(document.getElementById(`ratio_${f.spool_id}`).value) || 0;
                    ratios[f.spool_id] = val;
                });
                return ratios;
            }
        }).then(result => {
            if (result.isConfirmed) {
                const url = isDelete
                    ? `/history/delete/${printId}`
                    : `/history/reajust/${printId}`;

                fetch(url, {
                    method: \"POST\",
                    headers: { \"Content-Type\": \"application/json\" },
                    body: JSON.stringify({ restock: true, ratios: result.value })
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data.status && data.status.toLowerCase() === \"ok\") {
                        if (isDelete) {
                            const elt = document.getElementById(`print_${printId}`);
                            if (elt) elt.remove();
                        }
                        Swal.fire({
                            icon: \"success\",
                            title: \"Opération réussie\",
                            text: isDelete
                                ? `Le print #${printId} a été supprimé et les filaments réajustés.`
                                : `Les filaments du print #${printId} ont été réajustés.`,
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire(\"Erreur\", data.error || \"Impossible d'effectuer l'opération\", \"error\");
                    }
                });
            }
        });
    });
}
</script>
{% endblock %}
